{
	$name: 'DataCube.Widgets.Text',
	$parent: 'DataCube.Widgets.Widget',
	$require: ['JSB.Widgets.Button', 'JQuery.UI.Loader'],
	$expose: {
		name: 'Текст',
		description: '',
		category: 'Основные',
		icon: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSI0OHB4IiBpZD0ic3ZnNDE5OCIgd2lkdGg9IjQ4cHgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48ZGVmcyBpZD0iZGVmczQyMDAiPjxyYWRpYWxHcmFkaWVudCBjeD0iNjA1LjcxNDI5IiBjeT0iNDg2LjY0Nzg5IiBmeD0iNjA1LjcxNDI5IiBmeT0iNDg2LjY0Nzg5IiBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KC0yLjc3NDM4OSwwLDAsMS45Njk3MDYsMTEyLjc2MjMsLTg3Mi44ODU0KSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJyYWRpYWxHcmFkaWVudDUwMzEiIHI9IjExNy4xNDI4NiIgeGxpbms6aHJlZj0iI2xpbmVhckdyYWRpZW50NTA2MCIvPjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZWFyR3JhZGllbnQ1MDYwIj48c3RvcCBpZD0ic3RvcDUwNjIiIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6YmxhY2s7c3RvcC1vcGFjaXR5OjE7Ii8+PHN0b3AgaWQ9InN0b3A1MDY0IiBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOmJsYWNrO3N0b3Atb3BhY2l0eTowOyIvPjwvbGluZWFyR3JhZGllbnQ+PHJhZGlhbEdyYWRpZW50IGN4PSI2MDUuNzE0MjkiIGN5PSI0ODYuNjQ3ODkiIGZ4PSI2MDUuNzE0MjkiIGZ5PSI0ODYuNjQ3ODkiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMi43NzQzODksMCwwLDEuOTY5NzA2LC0xODkxLjYzMywtODcyLjg4NTQpIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9InJhZGlhbEdyYWRpZW50NTAyOSIgcj0iMTE3LjE0Mjg2IiB4bGluazpocmVmPSIjbGluZWFyR3JhZGllbnQ1MDYwIi8+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lYXJHcmFkaWVudDUwNDgiPjxzdG9wIGlkPSJzdG9wNTA1MCIgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjpibGFjaztzdG9wLW9wYWNpdHk6MDsiLz48c3RvcCBpZD0ic3RvcDUwNTYiIG9mZnNldD0iMC41IiBzdHlsZT0ic3RvcC1jb2xvcjpibGFjaztzdG9wLW9wYWNpdHk6MTsiLz48c3RvcCBpZD0ic3RvcDUwNTIiIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6YmxhY2s7c3RvcC1vcGFjaXR5OjA7Ii8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgyLjc3NDM4OSwwLDAsMS45Njk3MDYsLTE4OTIuMTc5LC04NzIuODg1NCkiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiBpZD0ibGluZWFyR3JhZGllbnQ1MDI3IiB4MT0iMzAyLjg1NzE1IiB4Mj0iMzAyLjg1NzE1IiB4bGluazpocmVmPSIjbGluZWFyR3JhZGllbnQ1MDQ4IiB5MT0iMzY2LjY0Nzg5IiB5Mj0iNjA5LjUwNTA3Ii8+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lYXJHcmFkaWVudDM1NTgiPjxzdG9wIGlkPSJzdG9wMzU2MCIgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojMDAwMDAwO3N0b3Atb3BhY2l0eToxOyIvPjxzdG9wIGlkPSJzdG9wMzU2MiIgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojMDAwMDAwO3N0b3Atb3BhY2l0eTowOyIvPjwvbGluZWFyR3JhZGllbnQ+PHJhZGlhbEdyYWRpZW50IGN4PSIyMi41NzE0MjgiIGN5PSIzMC44NTcxNDMiIGZ4PSIyMi41NzE0MjgiIGZ5PSIzMC44NTcxNDMiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMS4wMDAwMDAsMC4wMDAwMDAsMC4wMDAwMDAsMC42NTEzNzYsNC42Mzg2NDhlLTE1LDEwLjc1NzU0KSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJyYWRpYWxHcmFkaWVudDM1NjQiIHI9IjE1LjU3MTQyOCIgeGxpbms6aHJlZj0iI2xpbmVhckdyYWRpZW50MzU1OCIvPjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZWFyR3JhZGllbnQxNTIxOCI+PHN0b3AgaWQ9InN0b3AxNTIyMCIgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojZjhmOGY3O3N0b3Atb3BhY2l0eToxOyIvPjxzdG9wIGlkPSJzdG9wMjI2OSIgb2Zmc2V0PSIwLjU5OTI4NjU2IiBzdHlsZT0ic3RvcC1jb2xvcjojZThlOGU4O3N0b3Atb3BhY2l0eToxOyIvPjxzdG9wIGlkPSJzdG9wMTUyMjIiIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I2UyZTJkZTtzdG9wLW9wYWNpdHk6MTsiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KDEuMzQyNzA0LDAsMCwxLjIzNTM3OCwtOC4yMTk2MTEsLTcuNTQ5NDU3KSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIGlkPSJsaW5lYXJHcmFkaWVudDIyNDAiIHgxPSIyMC43OTQwMDgiIHgyPSIzNS41OTYwMDEiIHhsaW5rOmhyZWY9IiNsaW5lYXJHcmFkaWVudDE1MjE4IiB5MT0iMTguMzc4ODEzIiB5Mj0iMzkuNjAwNDYiLz48L2RlZnM+PGcgaWQ9ImxheWVyMSI+PGcgaWQ9Imc1MDIyIiBzdHlsZT0iZGlzcGxheTppbmxpbmUiIHRyYW5zZm9ybT0ibWF0cml4KDIuMzgyODExZS0yLDAsMCwxLjQ0ODc4OGUtMiw0NC45NDM1Myw0My43Nzg3OCkiPjxyZWN0IGhlaWdodD0iNDc4LjM1NzE4IiBpZD0icmVjdDQxNzMiIHN0eWxlPSJvcGFjaXR5OjAuNDAyMDYxODU7Y29sb3I6YmxhY2s7ZmlsbDp1cmwoI2xpbmVhckdyYWRpZW50NTAyNyk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMTMzOS42MzM1IiB4PSItMTU1OS4yNTIzIiB5PSItMTUwLjY5Njg1Ii8+PHBhdGggZD0iTSAtMjE5LjYxODc2LC0xNTAuNjgwMzggQyAtMjE5LjYxODc2LC0xNTAuNjgwMzggLTIxOS42MTg3NiwzMjcuNjUwNDEgLTIxOS42MTg3NiwzMjcuNjUwNDEgQyAtNzYuNzQ0NTk0LDMyOC41NTA4NiAxMjUuNzgxNDYsMjIwLjQ4MDc1IDEyNS43ODEzOCw4OC40NTQyMzUgQyAxMjUuNzgxMzgsLTQzLjU3MjMwMiAtMzMuNjU1NDM2LC0xNTAuNjgwMzYgLTIxOS42MTg3NiwtMTUwLjY4MDM4IHogIiBpZD0icGF0aDUwNTgiIHN0eWxlPSJvcGFjaXR5OjAuNDAyMDYxODU7Y29sb3I6YmxhY2s7ZmlsbDp1cmwoI3JhZGlhbEdyYWRpZW50NTAyOSk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIi8+PHBhdGggZD0iTSAtMTU1OS4yNTIzLC0xNTAuNjgwMzggQyAtMTU1OS4yNTIzLC0xNTAuNjgwMzggLTE1NTkuMjUyMywzMjcuNjUwNDEgLTE1NTkuMjUyMywzMjcuNjUwNDEgQyAtMTcwMi4xMjY1LDMyOC41NTA4NiAtMTkwNC42NTI1LDIyMC40ODA3NSAtMTkwNC42NTI1LDg4LjQ1NDIzNSBDIC0xOTA0LjY1MjUsLTQzLjU3MjMwMiAtMTc0NS4yMTU3LC0xNTAuNjgwMzYgLTE1NTkuMjUyMywtMTUwLjY4MDM4IHogIiBpZD0icGF0aDUwMTgiIHN0eWxlPSJvcGFjaXR5OjAuNDAyMDYxODU7Y29sb3I6YmxhY2s7ZmlsbDp1cmwoI3JhZGlhbEdyYWRpZW50NTAzMSk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIi8+PC9nPjxyZWN0IGhlaWdodD0iNDUuMDAzMTAxIiBpZD0icmVjdDQyMzgiIHJ4PSIwLjU2NjUwNzg4IiByeT0iMC41NjY1MDgyMyIgc3R5bGU9Im9wYWNpdHk6MTtmaWxsOnVybCgjbGluZWFyR3JhZGllbnQyMjQwKTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6Izg4OGE4NTtzdHJva2Utd2lkdGg6MC45OTk5OTk3NjtzdHJva2UtbGluZWNhcDpidXR0O3N0cm9rZS1saW5lam9pbjptaXRlcjtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO3N0cm9rZS1vcGFjaXR5OjEiIHdpZHRoPSIzOC45OTY3OTIiIHg9IjQuNTAxNjAxNyIgeT0iMC41MjQ2MjcyMSIvPjxyZWN0IGhlaWdodD0iMiIgaWQ9InJlY3Q0MjQ4IiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6Izk5OTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpidXR0O3N0cm9rZS1saW5lam9pbjptaXRlcjttYXJrZXI6bm9uZTttYXJrZXItc3RhcnQ6bm9uZTttYXJrZXItbWlkOm5vbmU7bWFya2VyLWVuZDpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1kYXNob2Zmc2V0OjA7c3Ryb2tlLW9wYWNpdHk6MTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZSIgd2lkdGg9IjE0IiB4PSIyMiIgeT0iOS4wMjc3MjcxIi8+PHJlY3QgaGVpZ2h0PSIyIiBpZD0icmVjdDQyNTAiIHN0eWxlPSJvcGFjaXR5OjE7Y29sb3I6YmxhY2s7ZmlsbDojOTk5O2ZpbGwtb3BhY2l0eToxO2ZpbGwtcnVsZTpldmVub2RkO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDoxO3N0cm9rZS1saW5lY2FwOmJ1dHQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMTIiIHg9IjIyIiB5PSIxNS4wMjc3MjciLz48cmVjdCBoZWlnaHQ9IjIiIGlkPSJyZWN0NDI1MiIgc3R5bGU9Im9wYWNpdHk6MTtjb2xvcjpibGFjaztmaWxsOiM5OTk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7bWFya2VyOm5vbmU7bWFya2VyLXN0YXJ0Om5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1lbmQ6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO3N0cm9rZS1vcGFjaXR5OjE7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGUiIHdpZHRoPSIyMi45NzE1MzEiIHg9IjkiIHk9IjIxLjAyNzcyNyIvPjxyZWN0IGhlaWdodD0iMiIgaWQ9InJlY3Q0MjU0IiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6Izk5OTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpidXR0O3N0cm9rZS1saW5lam9pbjptaXRlcjttYXJrZXI6bm9uZTttYXJrZXItc3RhcnQ6bm9uZTttYXJrZXItbWlkOm5vbmU7bWFya2VyLWVuZDpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1kYXNob2Zmc2V0OjA7c3Ryb2tlLW9wYWNpdHk6MTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZSIgd2lkdGg9IjI3IiB4PSI5IiB5PSIyNy4wMjc3MjciLz48cmVjdCBoZWlnaHQ9IjIiIGlkPSJyZWN0NDI1NiIgc3R5bGU9Im9wYWNpdHk6MTtjb2xvcjpibGFjaztmaWxsOiM5OTk7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7bWFya2VyOm5vbmU7bWFya2VyLXN0YXJ0Om5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1lbmQ6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO3N0cm9rZS1vcGFjaXR5OjE7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGUiIHdpZHRoPSIxNyIgeD0iOSIgeT0iMzMuMDI3NzQ4Ii8+PHJlY3QgaGVpZ2h0PSI0My4wMjIzMTYiIGlkPSJyZWN0MjI0NSIgcng9IjAiIHJ5PSIwIiBzdHlsZT0ib3BhY2l0eToxO2ZpbGw6bm9uZTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6d2hpdGU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxIiB3aWR0aD0iMzcuMDAwMDE5IiB4PSI1LjQ5OTcxNTMiIHk9IjEuNTI3NDQ1NiIvPjxyZWN0IGhlaWdodD0iMTAiIGlkPSJyZWN0NDgzNyIgc3R5bGU9Im9wYWNpdHk6MTtmaWxsOiM5OTk7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1kYXNob2Zmc2V0OjA7c3Ryb2tlLW9wYWNpdHk6MSIgd2lkdGg9IjExIiB4PSI5IiB5PSI5LjAyNzcyNzEiLz48cmVjdCBoZWlnaHQ9IjYiIGlkPSJyZWN0MTMyMyIgc3R5bGU9Im9wYWNpdHk6MC41O2NvbG9yOmJsYWNrO2ZpbGw6IzcyOWZjZjtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7bWFya2VyOm5vbmU7bWFya2VyLXN0YXJ0Om5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1lbmQ6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO3N0cm9rZS1vcGFjaXR5OjE7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGUiIHdpZHRoPSIyOSIgeD0iOCIgeT0iMTMuMDI3NzI3Ii8+PHJlY3QgaGVpZ2h0PSI2IiBpZD0icmVjdDIxOTgiIHN0eWxlPSJvcGFjaXR5OjAuNTtjb2xvcjpibGFjaztmaWxsOiM3MjlmY2Y7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMzEiIHg9IjgiIHk9IjcuMDI3NzI3MSIvPjxyZWN0IGhlaWdodD0iNiIgaWQ9InJlY3QyMjAwIiBzdHlsZT0ib3BhY2l0eTowLjU7Y29sb3I6YmxhY2s7ZmlsbDojNzI5ZmNmO2ZpbGwtb3BhY2l0eToxO2ZpbGwtcnVsZTpub256ZXJvO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDoxO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDttYXJrZXI6bm9uZTttYXJrZXItc3RhcnQ6bm9uZTttYXJrZXItbWlkOm5vbmU7bWFya2VyLWVuZDpub25lO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1kYXNob2Zmc2V0OjA7c3Ryb2tlLW9wYWNpdHk6MTt2aXNpYmlsaXR5OnZpc2libGU7ZGlzcGxheTppbmxpbmU7b3ZlcmZsb3c6dmlzaWJsZSIgd2lkdGg9IjI1IiB4PSI4IiB5PSIxOS4wMjc3MjciLz48cmVjdCBoZWlnaHQ9IjYiIGlkPSJyZWN0MjIwMiIgc3R5bGU9Im9wYWNpdHk6MC41O2NvbG9yOmJsYWNrO2ZpbGw6IzcyOWZjZjtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZTtzdHJva2Utd2lkdGg6MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7bWFya2VyOm5vbmU7bWFya2VyLXN0YXJ0Om5vbmU7bWFya2VyLW1pZDpub25lO21hcmtlci1lbmQ6bm9uZTtzdHJva2UtbWl0ZXJsaW1pdDo0O3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2UtZGFzaG9mZnNldDowO3N0cm9rZS1vcGFjaXR5OjE7dmlzaWJpbGl0eTp2aXNpYmxlO2Rpc3BsYXk6aW5saW5lO292ZXJmbG93OnZpc2libGUiIHdpZHRoPSIyOSIgeD0iOCIgeT0iMjUuMDI3NzI3Ii8+PHJlY3QgaGVpZ2h0PSI2IiBpZD0icmVjdDIyMDQiIHN0eWxlPSJvcGFjaXR5OjAuNTtjb2xvcjpibGFjaztmaWxsOiM3MjlmY2Y7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMTkiIHg9IjgiIHk9IjMxLjAyNzcyNyIvPjxyZWN0IGhlaWdodD0iNyIgaWQ9InJlY3QyMjA2IiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6YmxhY2s7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMSIgeD0iMjgiIHk9IjMxLjAyNzcyNyIvPjxyZWN0IGhlaWdodD0iMSIgaWQ9InJlY3QyMjA4IiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6YmxhY2s7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMSIgeD0iMjciIHk9IjMwLjAyNzcyNyIvPjxyZWN0IGhlaWdodD0iMSIgaWQ9InJlY3QyMjEwIiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6YmxhY2s7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMSIgeD0iMjkiIHk9IjMwLjAyNzcyNyIvPjxyZWN0IGhlaWdodD0iMSIgaWQ9InJlY3QyMjEyIiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6YmxhY2s7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMSIgeD0iMjkiIHk9IjM4LjAyNzc0OCIvPjxyZWN0IGhlaWdodD0iMSIgaWQ9InJlY3QyMjE0IiBzdHlsZT0ib3BhY2l0eToxO2NvbG9yOmJsYWNrO2ZpbGw6YmxhY2s7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO21hcmtlcjpub25lO21hcmtlci1zdGFydDpub25lO21hcmtlci1taWQ6bm9uZTttYXJrZXItZW5kOm5vbmU7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLWRhc2hvZmZzZXQ6MDtzdHJva2Utb3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZTtkaXNwbGF5OmlubGluZTtvdmVyZmxvdzp2aXNpYmxlIiB3aWR0aD0iMSIgeD0iMjciIHk9IjM4LjAyNzc0OCIvPjwvZz48L3N2Zz4='
	},
    $scheme: {
        source: {
            render: 'sourceBinding',
            name: 'Источник',
        },
        text: {
            render: 'dataBinding',
            name: 'Текст',
            linkTo: 'source'
        },
        annotations: {
            render: 'dataBinding',
            name: 'Разметка',
            linkTo: 'source'
        },
        hideWithoutAnnotations: {
            render: 'item',
            name: 'Скрывать абзацы без выделений',
            optional: true,
            editor: 'none'
        },
        cssText: {
            render: 'switch',
            name: 'Использовать CSS стиль текста',
            items: {
                cssStyle: {
                    render: 'item',
                    name: 'CSS стиль',
                    editor: 'JSB.Widgets.MultiEditor',
                    editorOpts: {
                        valueType: 'org.jsbeans.types.Css'
                    },
                    value: `/* Заполните объект CSS значениями */`
                }
            }
        },
        cssMark: {
            render: 'switch',
            name: 'Использовать CSS стиль выделений',
            items: {
                cssStyle: {
                    render: 'item',
                    name: 'CSS стиль',
                    editor: 'JSB.Widgets.MultiEditor',
                    editorOpts: {
                        valueType: 'org.jsbeans.types.Css'
                    },
                    value: `/* Заполните объект CSS значениями */`
                }
            }
        }
    },
	$client: {
		$require: ['css:text.css'],
		highlights: [],

		$constructor: function(opts){
			var self = this;
			$base(opts);
			this.addClass('textWidget');
			$this.setInitialized();
		},

		refresh: function(opts){
		    this.onRefresh(opts);
		},

		onRefresh: function(opts){
		    var dataSource = this.getContext().find('source');
            if(!dataSource.hasBinding || !dataSource.hasBinding()){
                return;
            }
            
			$base();

            this.getElement().loader();

            if(opts && opts.refreshFromCache){
                this.redraw();
                return;
            }

            this.fetch(dataSource, {batchSize: 1}, function(data, fail){
            	if(fail){
            		return;
            	}
                dataSource.next();
                $this.update();
            });
        },

        update: function(){
            this.text = this.getContext().find('text').value();
            this.text = this.text.replace(/_x000D_/g , ' ');

            var annot = this.getContext().find('annotations').value();
            if(!JSB().isArray(annot)) annot = [annot];

            if(annot.length > 0){
                try{
                    this.highlights = [];

                    for(var i = 0; i < annot.length; i++){
                        var h = JSON.parse(annot[i]);

                        this.highlights.push({
                            id: h.id,
                            docId: h.document_id,
                            offset: h.start,
                            length: h.end - h.start
                        });
                    }

                    this.highlights.sort(function(a, b){
                        return a.offset - b.offset;
                    });

                    var fObj = {};
                    this.highlights = this.highlights.filter(function(el){
                        for(var i = el.offset; i < el.offset + el.length; i++){
                            if(fObj[i]){
                                return false;
                            }
                        }

                        for(var i = el.offset; i < el.offset + el.length; i++){
                            fObj[i] = true;
                        }

                        return true;
                    });

                } catch(ex){
                    console.log(ex);
                }
            }

            this.redraw();

            var cssSelector = this.getContext().find('cssText');
            if(cssSelector.checked()){
                this.getElement().attr("style", this.prepareCss(cssSelector.find('cssStyle').value()));
            }

            $this.getElement().loader('hide');
        },

        prepareCss: function(cssText){
            if(!cssText) return "";
            if(cssText.indexOf('{') >= 0){
                var m = cssText.match(/\{([^\}]*)\}/i);
                if(m && m.length > 1){
                    cssText = m[1];
                }
            }
            return cssText.replace(/\r/g,'').replace(/\n/g,'').trim();
        },

		redraw: function(){
			var self = this;
			this.getElement().empty();

			// inject highlight marks
			var html = this.text;
			var deltaOffset = 0;
			var lastSize = html.length;

			for(var i = 0; i < this.highlights.length; i++){
				var h = this.highlights[i];
				var fromIdx = h.offset + deltaOffset;
				var toIdx = fromIdx + h.length;
				// do replace
				var prefix = html.substr(0, fromIdx);
				var postfix = html.substr(toIdx);
				var highlightStr = html.substr(fromIdx, toIdx - fromIdx);
				html = prefix + '<span class="highlight" hid="'+h.id+'">' + highlightStr + '</span>' + postfix;
				var newSize = html.length;
				var oddSize = newSize - lastSize;
				lastSize = newSize;
				deltaOffset += oddSize;
			}

			var pArr = html.split('\n');

			if(this.getContext().find('hideWithoutAnnotations').checked()){
                var collStr = '';
                for(var i = 0; i < pArr.length; i++){
                    var pTxt = pArr[i];
                    if(pTxt.trim().length !== 0){
                        var pElt = '<p>' + pTxt + '</p>';

                        if(pTxt.indexOf('<span class="highlight"') < 0){
                            collStr += pElt;
                        } else {
                            if(collStr.length > 0){
                                this.append(`#dot
                                    <div class="collapseBlock">
                                    <div jsb="JSB.Widgets.Button"
                                         caption="* * *"
                                         onclick="{{=this.callbackAttr(function(evt){ this.getElement().addClass('hidden'); })}}" >
                                    </div>
                                    <div class="pointCollapse">
                                        {{=collStr}}
                                    </div>
                                    </div>
                                `);
                                collStr = '';
                            }

                            this.append(pElt);
                        }
                    }
                }
			} else {
                for(var i = 0; i < pArr.length; i++){
                    var pTxt = pArr[i];
                    if(pTxt.trim().length !== 0){
                        var pElt = this.$('<p></p>').append(pTxt);
                        this.append(pElt);
                    }
                }
			}

            var cssSelector = this.getContext().find('cssMark');
            if(cssSelector.checked()){
                this.find('span.highlight').attr("style", this.prepareCss(cssSelector.find('cssStyle').value()));
            }
		},

		activateHighlight: function(hid){
			var hElt = this.find('span.highlight[hid="'+hid+'"]');
			if(hElt.length === 0){
				return;
			}
			this.find('span.highlight').removeClass('active');
			hElt.addClass('active');
			return hElt;
		}
	}
}