## Язык запросов к кубу

Выполнение запроса и получение итератора - Query.execute(queryDescriptor).

Дескриптор запроса включает поля:
* cube - куб по умолчанию
* query - тело запроса
```
{
    $select: {название выходного поля: выражение значения},
    $filter: {фильтр на входные поля},
    $groupBy: [выражения группировки или алиасы],
    $sort: [выражения сортировки по входным или выходным полям],
    $postFilter: {фильтр на выходные поля},
    $offset: смещение,
    $limit: ограничение числа строк,
    
    $params: 
    
    $from/$join/$union/$recursive/$provider/$cube: источник запроса
}
```
* params - значения параметров запроса - `{ name: value }`

# Резовинг полей и контекстов

Поле задается в двух формах:
* `{$field: "имя поля"}` - подразумевается, что используется контекст текущего запроса
* `{$field: "имя поля", $context: "имя контекста"}`

1) если контекст соответствует текущему запросу, в котором определено выражение, использующее поле, 
то в первую очередь берется поле источника текущего запроса

# $select - формирование выходной строки

# $filter - фильтрация по полям источника

Фильтрация может быть задана в двух формах:
* короткая - { "имя поля": { $ оператор условия : выражение/константа } }
* полная - { $ оператор условия : [ аргументы-выражениями ] }

Обе формы записи поддерживают массивы $and и $or, где каждый элемент может быть в любой форме записи.


# $groupBy - определение группировки

# $sort - сортировка по входными или выходным полям 

# $postFilter - фильтрация по выходным полям

Аналогично $filter, но в качестве полей могут использоваться только выходные.

# источник запроса

## $from

## $join

## $union

## $recursive

```
$recursive: {
    $start: { запрос получения первого набора } 
    $joinedNext: { запрос рекурсивно присоединяемых наборов }
    $filter: { условия рекурсивного присоединения наборос}
}
```

$start - запрос для получения самого первого набора строк, включаемого в вывод рекурсивного запроса. Составляется как обычный запрос, может содержать поля своего источника и константы для задания начальных значений.
$joinedNext - запрос для получения рекурсивно присоединяемых наборов (результат рекурсии присоединяется через JOIN к результатам текущего запроса). Должен иметь те же выходные поля и источник, что и $start, может использовать поля своего источника и поля результатов прерыдущих наборов рекурсии (т.е. поля контекста освновного запроса с $recursive).
$filter - задает условия приединения, должен использовать выходные поля $joinedNext и выходные поля запроса с рекурсией.  

Пример:
```
{
  "$context": "Q4",
  "$select": {
    "Столбец": {
      "$field": "depth"
    }
  },
  "$recursive": {
    "$start": {
      "$context": "Q2",
      "$select": {
        "value": {
          "$field": "4． Утвержденные бюджетные назначения 0503117 (Мун．ФО/ДФ) 2016"
        },
        "id": {
          "$field": "РЗПРЗ"
        },
        "parentId": {
          "$field": "РЗПРЗ родитель"
        },
        "depth": {
          "$const": 0,
          "$type": "double"
        }
      },
      "$from": "a1f2f44103d7d846942093298e288643/a4572943a92987c905c0b77cbcaeecc0"
    },
    "$joinedNext": {
      "$context": "Q3",
      "$select": {
        "value": {
          "$field": "4． Утвержденные бюджетные назначения 0503117 (Мун．ФО/ДФ) 2016"
        },
        "id": {
          "$field": "РЗПРЗ"
        },
        "parentId": {
          "$field": "РЗПРЗ родитель"
        },
        "depth": {
          "$add": [
            {
              "$field": "depth",
              "$context": "Q4"
            },
            {
              "$const": 1,
              "$type": "double"
            }
          ]
        }
      },
      "$from": "a1f2f44103d7d846942093298e288643/a4572943a92987c905c0b77cbcaeecc0"
    },
    "$filter": {
      "$eq": [
        {
          "$field": "id",
          "$context": "Q2"
        },
        {
          "$context": "Q4",
          "$field": "parentId"
        }
      ]
    }
  }
}
```

## $provider

## $cube

# Разное 

```
{
    $select: {
        "Код отрасли": {$toInt: "Код отрасли"},
        "Число показателей отрасли": {$sum:1},
        "Сумма показателей отрасли": {$sum: {$toDouble: "Значение"}},
        "Число отраслей": {$gcount: {$distinct: "Код отрасли"}},
        "Сумма показателей": {$gsum: {$toDouble: "Значение"}},
    },
    $groupBy: ["Код отрасли"],
    $postFilter: {
        "Сумма показателей" : {$gt: {$const:0}}
    }
    
}
```

## Функции преобразования значения

Применяются в секции $select.

`$toInt, $toDouble, $toString, $toBoolean, $toDate, $distinct`

`$dateYear, $dateMonth` - извчение года и месяца из даты

`$dateTotalSeconds` - извлечение секунд из даты начиная с 1970-01-01

`$dateIntervalOrder: {$field: "field", $seconds: 31536000}` - разбиение даты на интервалы и приведение к порядковому номеру интервала, используется для группировки по интервалам дат

`$trim` - удаление лишних пробелов в строках

### Функции N-арные операторы

`$add, $sub, $mod, $div, $divz, $mul`
 
В качестве значения принимают массив выражений, например - `{ $add: [ ... ] }`

Выбор максимального или минимального значения из нескольких - `{$greatest: [ ... ]}`, `{$least: [ ... ]}`


## Работа с константами и несколькими полями в $select, формирование формул

Задание строковой или числовой константы в качестве аргумента - `{$const: 123}`.
Задание имени поля в качестве аргумента - 'field_name', `{$field: 'field_name'}`
 
 ``` 
{
    $select: {
        'constValue' : {$const: 123},
        'add': {$add:[{$const: 123}, 'my_field1']},
        'mul': {$mul:['my_field1', 'my_field2']},
        'formula': {$div: [{$mul:['my_field1', 'my_field2']}, {$const:100}]}
    }
}
 ```
 

### Функции группировки

Применяются в секции $select.

`$sum: 1, $sum, $count: 1, $count, $min, $max, $avg, $array, $flatArray`

### Глобавльные функции группировки

Применяются в секции $select и формируют глобальное агрегированное значение над всей выборкой. Значение будет одно и то же для всех объектов выходной выборки.

`$gcount: 1, $gcount, $gsum: 1, $gsum, $gmax, $gmin`

### Функции группировки "над группой"

Применяются в секции $select и формируют глобальное агрегированное значение, полученное путем применения глобальной функции агрегации над агреггированными значениями в группе. Фактиечски находит группу с максимальным значением агррегированного поля.


`$grmaxsum` - вычисляет максимальное значение суммы значений в группе
`$grmaxcount` - вычисляет максимальное значение числа значений в группе
`$grmaxavg` - вычисляет максимальное значение среднего значений в группе

### Функции фильтрации

Применяются в секции $filter для фильтрации выборки по значениям полей. 

`$or, $and, $not, {$eq: null}, $eq, {$ne: null}, $ne, $gt, $gte, $lt, $lte, $like, $ilike, $in, $nin`

Задание имени поля в качестве значения условия - `{$field: 'field_name'}` 
Задание строковой или числовой константы в качестве значения условия - `{$const: 123}` 


```{
    $select: {...},
    $filter: {
        "Код отрасли": {$like: '${like}'},
        "Значение": {$ne: null}
    }
},
{
    like: "*"
}
```

### Функции пост-фильтрации
$postFilter - используется для фильтрации результирующей выборки (после агрегации) 


### Функции пост-обработки

Применяются в секции $finalize.

`{ $splitString: {$field: 'myField', $separator: ", "} }` - разбивает строку и превращает в массив строк
`{ $substring: {$field:'myField', $length: 123}}`

```
{
    $select: {...},
    $filter: {
        "Код отрасли": {$like: '${like}'},
        "Значение": {$ne: null}
    },
    $finalize: {
        'myField': {
            $splitString: {
                $field: 'myField', 
                $separator: ", "
            }
        }
    }
}
```

### Использование контекстов и построение подзапросов

Подзапросы бывают двух типов:
1) в секции $select для формирования значения (например, по условиям на значения из родительского запроса)
2) в поле $from для выполнения запроса над подзапросом (запроса к виртуальной таблице, сформированной подзапросом)

Для именования запроса или подзапроса используются контексты - поле $context, 
принимающее строку с идентификатором контекста, кооторый потом может использоватья для ссылки на поля конкретного запроса/подзапроса.

`{$field: 'context field alias', $context:'my-query''}` - задание поля, принадлежащему конкретному контексту.

#### Пример подзапроса  
Нормированная выручка нетто от продаж (по годам и предприятиям) = `( (максимальное значение выручки нетто от продажи товаров, продукции, работ, услуг за период  - "Выручка нетто от продажи товаров, продукции, работ, услуг")/максимальное значение выручки нетто от продажи товаров, продукции, работ, услуг за период  )*100`

Структура:
1) `$from: { $context: "sub3", ... }`- формирует сумму показателя по годам и предприятиям с фильрацией текущего года, соответствующего году из родительского запроса
2) `{ $context: "sub2", $from: { ... } }` - берется максимальное значение (тобишь значение предприятия с максимальной суммой за текущий год) 
3) Максимальное значение является единственным для каждой группы родительского запроса и он участвует в формуле нормирования в родительском запросе "main"

```
{
    "$groupBy": [
        "Наименование предприятия",
        "Год"
    ],
    "$context": "main",
    "$select": {
        "Нормированная выручка нетто от продаж": {
            "$mul": [
                {
                    "$div": [
                        {
                            "$sub": [
                                {
                                    "$context": "sub2",
                                    "$from": {
                                        "$context": "sub3",
                                        "$groupBy": [
                                            "Наименование предприятия",
                                            "Год"
                                        ],
                                        "$filter": {
                                            "Год": {
                                                "$eq": {
                                                    "$context": "main",
                                                    "$field": "Год"
                                                }
                                            }
                                        },
                                        "$select": {
                                            "Выручка предприятия за год": {
                                                "$sum": "Выручка нетто от продажи товаров, продукции, работ, услуг"
                                            }
                                        }
                                    },
                                    "$select": {
                                        "Максимальная выручка за год": {
                                            "$max": {
                                                "$context": "sub2",
                                                "$field": "Выручка предприятия за год"
                                            }
                                        }
                                    }
                                },
                                {
                                    "$sum": "Выручка нетто от продажи товаров, продукции, работ, услуг"
                                }
                            ]
                        },
                        {
                            "$max": "Выручка нетто от продажи товаров, продукции, работ, услуг"
                        }
                    ]
                },
                {
                    "$const": 100
                }
            ]
        },
        "Год": "Год",
        "Наименование предприятия": "Наименование предприятия"
    }
}
```

### Синтаксис
TODO: update
````
query             := '{' select [filter] [groupBy] [sort] '}'

select            := '$select: {' [fieldSelection] '}' 
fieldSelection    := resultFieldAlias ':' fieldExpression [',' fieldSelection]
fieldExpression   := fieldName | valueFunction | aggregateFunction

aggregateFunction := '{' (
        '$sum' | '$count' |
        '$min' | '$max' | '$avg' | 
        '$array' | '$flatArray'
    ) ':' valueFunction '}' | '{$sum: 1}' | '{$count: 1}' 
    
valueFunction     := '{' (
        '$toInt' | '$toDouble' | 
        '$toString' | '$toBoolean' | 
        '$distinct') ':' fieldName | valueFunction '}'
        
filter            := '{' [filterSelection] '}'
filterSelection   := 
        '$or:[' filterSelection ']' | 
        '$and:[' filterSelection ']' | 
        fieldName ':' filterOperator [',' filterSelection]
filterOperator    := '{' (): filterValue '}' | '{$eq:null}' | '{$ne: null}'
filterValue :=

groupBy    := '[' fieldNames ']'
sort       := '[' fieldNames ']'
fieldNames := fieldName [',' fieldNames]
``