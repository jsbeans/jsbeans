{
	$name: 'DataCube.Query.Transforms.EmbedCubeBody',
	$parent: 'DataCube.Query.Transforms.Transformer',
	$session: false,
	$server: {
		$require: [
		    'DataCube.Query.QueryUtils',
		    'DataCube.Query.Transforms.QueryTransformer',
		    'DataCube.Query.Views.CubeViewsBuilder',
        ],

        /** Find and replace $cube -> $from (1th generation)
        */
		transform: function(dcQuery, cube){

		    QueryUtils.walkQueries(dcQuery, {},
		        function(query){
                    if (QueryUtils.hasDeclaredSource(query)) {
                        try {
                            var queryCube = query.$cube ? QueryUtils.getQueryCube(query.$cube, cube) : cube;

                            var usedFields = QueryUtils.extractInputFields(query, queryCube, dcQuery);

                            if (Object.keys(usedFields).length == 0) {
                                query.$from = {};
                                return;
                            }

                            var providers = QueryUtils.extractCubeProvidersInQuery(query, queryCube, dcQuery);
                            var builder = new CubeViewsBuilder(queryCube, providers);
                            var view = builder.build(query.$context, usedFields);
                            query.$from = view.getFromBody();
                        } finally {
                            builder && builder.destroy();
                            view && view.destroy();
                        }

                    }
                },
		        function() { }
            );

		    QueryUtils.defineContextQueries(dcQuery);
		    return dcQuery;
		},
	}
}